# Inspect Azure Application Gateway Internet Bound Traffic Using an NVA

## Preface

The distributed nature of the cloud coupled with the evolution of the threat landscape in recent years calls for a paradigm shift in how we think about security in general and network security in particular. Gone are the days when placing a firewall at the edge of our network was enough to keep the bad guys at bay, and although firewalls still offer tremendous value for securing our network they cannot be the centerpiece of our network security strategy when it comes to cloud; instead we need to take a distributed approach to network security, leveraging cloud native tools like Cloud Workload Protection Platforms ([CWPP](https://www.gartner.com/reviews/market/cloud-workload-protection-platforms)) and Cloud Security Posture Management ([CSPM](https://www.gartner.com/documents/3899373/innovation-insight-for-cloud-security-posture-management)) like [Azure Security Center](https://docs.microsoft.com/azure/security-center/security-center-introduction), cloud native SIEM and Security Operations Automation and Response systems ([SOAR](https://www.gartner.com/reviews/market/security-orchestration-automation-and-response-solutions)) like [Azure Sentinel](https://techcommunity.microsoft.com/t5/azure-sentinel/bg-p/AzureSentinelBlog), host based IDS and IPS and agents across our infrastructure components.

This distributed approach to security is even more relevant when working with PaaS services that can be deployed natively in the customer's virtual network which, due to their managed nature, need to communicate with the cloud provider's control plane that sits on the Internet, and the very thought of this makes a lot of people nervous. One of those services, and the focus of this article is [Azure Application Gateway](https://docs.microsoft.com/azure/application-gateway/overview). Often customers want to inspect traffic sourced from Azure Application Gateway through a Firewall, and although concerns about data exfiltration, command and control botnets and other attacks are very valid and need to be taken seriously, this architecture, from my perspective, adds little to no value at all because of the following reasons:

- Azure Application Gateway is a reverse proxy for HTTP, HTTPS, HTTP/2 and WebSockets traffic, as such it doesn't initiate outbound Internet traffic, rather it relays responses coming from the backend servers back to the clients that originated the request. If Application Gateway receives traffic from a backend server that doesn't correspond to a previously received request it will be dropped; thus if a backend server is compromised through lateral movement or any other attack vector it cannot use Azure Application Gateway as a proxy towards the Internet

- [Azure Web Application Firewall](https://docs.microsoft.com/azure/web-application-firewall/ag/ag-overview) can be associated with Azure Application Gateway, this protects the backend servers from malicious requests. It can also leverage [Microsoft Threat Intelligence feed](https://docs.microsoft.com/azure/web-application-firewall/ag/bot-protection-overview) to block requests from known malicious IP addresses

- In order to compromise Azure Application Gateway an entity would require to gain access into it. Although Azure Application Gateway requires that certain ports remain open in order to allow management of the service, [these ports are protected by Azure Certificates](https://docs.microsoft.com/azure/application-gateway/configuration-infrastructure#network-security-groups) to only allow connections coming from Azure GatewayManager service

- [Network Security Groups can be configured in the Application Gateway Subnet](https://docs.microsoft.com/azure/application-gateway/configuration-infrastructure#network-security-groups), further restricting the sources that can connect to it. Additionally the service tag for GatewayManager service can be leveraged, restricting Internet clients to only web traffic destined to the ports configured on the listeners

- Most regulatory compliance standards require traffic to be inspected by a Firewall, however these standards consider Azure NSGs Firewalls, which are supported with Azure Application Gateway, and although [NSG flow logs are not supported on NSGs associated to Application Gateway v2 subnet](https://docs.microsoft.com/azure/application-gateway/application-gateway-faq#are-nsg-flow-logs-supported-on-nsgs-associated-to-application-gateway-v2-subnet), Azure Application Gateway offers [comprehensive logging](https://docs.microsoft.com/azure/application-gateway/application-gateway-diagnostics#diagnostic-logging) that can be used for compliance reporting as well as to analyze and investigate traffic patterns

- [Azure Web Application Firewall integrates with Azure Sentinel](https://techcommunity.microsoft.com/t5/azure-network-security/integrating-azure-web-application-firewall-with-azure-sentinel/ba-p/1720306), making it easier for security teams to visualize patterns, detect potential malicious activities and respond to threats faster, as well as [detect and defend against data disclosure and exfiltration](https://techcommunity.microsoft.com/t5/azure-network-security/part-4-data-disclosure-and-exfiltration-playbook-azure-waf/ba-p/2031269) using the [Azure Monitor Workbook for WAF](https://github.com/Azure/Azure-Network-Security/tree/master/Azure%20WAF/Azure%20Monitor%20Workbook)

- Azure Security Center Standard Tier can be used to detect compromised servers and data exfiltration directly at the servers through the Log Analytics Agent for Windows and Linux servers, not only in Azure but also on premises and any other cloud, rather than needing to rely on a centralized control point like a firewall. You can review the [set of alerts](https://docs.microsoft.com/azure/security-center/alerts-reference) that Azure Security Center surfaces for IaaS and PaaS services. Even if you decide to inspect Application Gateway traffic through a firewall, I urge you to consider implementing Azure Security Center Standard Tier in your security strategy as it provides invaluable information to keep your cloud environment secure

- Inspecting Azure Application Gateway traffic through a firewall can block the communication with the control plane due to misconfiguration, which can result in a self inflicted DoS attack rendering your service unavailable

If after reading this section you still need to inspect all traffic from Application Gateway through a firewall keep on reading to learn how you can accomplish this.

## Overview